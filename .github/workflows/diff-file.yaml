name: GitHub Actions Demo2
run-name: diff-file
on:
  [push]
  # push:
  #   paths:
  #     - 'xxx/*/version.json'
jobs:
    job1:
        runs-on: ubuntu-latest
        steps:
          - name: Check out repository code
            uses: actions/checkout@v4.2.2
          - name: Print Environment
            run: |
              set -euo pipefail

              git fetch origin ${{ github.event.before }} --depth=1

              ENVIRONMENTS=(dev stg prd)
              DETECTED_ENVIRONMENTS=()

              echo "github.event.before: ${{ github.event.before }}"
              echo "github.sha: ${{ github.sha }}"

              # 環境ごとに変更があるか確認。
              for ENVIRONMENT in ${ENVIRONMENTS[@]}; do
                # 過去、現在のコミットのversionを取得
                before_version=$(git show ${{ github.event.before }}:xxx/${ENVIRONMENT}/version.json | jq -r '.version')
                current_version=$(git show ${{ github.sha }}:xxx/${ENVIRONMENT}/version.json | jq -r '.version')

                # バージョンの差を確認
                if [ "$before_version" != "$current_version" ]; then
                  echo "Version has changed: $before_version -> $current_version"
                  DETECTED_ENVIRONMENTS+=("$ENVIRONMENT")
                else
                  echo "Version has not changed: $current_version"
                fi
              done

              echo "DETECTED_ENVIRONMENTS: ${DETECTED_ENVIRONMENTS[@]}"

