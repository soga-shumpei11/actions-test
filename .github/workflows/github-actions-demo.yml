name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions üöÄ
on:
  push:
    paths:
      - 'xxx/*/version.json'
jobs:
  test-set-modify-file-path:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4.2.2
      - name: Get list of changed files
        id: changed_files
        run: |
          set -euo pipefail
          git fetch origin ${{ github.event.before }} --depth=1
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
          cat changed_files.txt

          ENVIRONMENTS=()
          while read file; do
            case "$file" in
              'xxx/dev/version.json')
                ENVIRONMENTS+=("dev")
                ;;
              'xxx/stg/version.json')
                ENVIRONMENTS+=("stg")
                ;;
              'xxx/prd/version.json')
                ENVIRONMENTS+=("prd")
                ;;
            esac
          done < changed_files.txt

          echo "${ENVIRONMENTS[@]}"

          json=$(jq -n --argjson ENVIRONMENTS "$(printf '%s\n' "${ENVIRONMENTS[@]}" | jq -R . | jq -s .)" \
            '{"include": [$ENVIRONMENTS | .[] | {env: .}]}')
          echo "matrix=${json}" 
          echo "matrix=${json}" >> $GITHUB_OUTPUT
  test-get-modify-file-path:
    runs-on: ubuntu-latest
    needs: test-set-modify-file-path
    strategy:
      matrix:
        environment: ${{ fromJSON(needs.test-set-modify-file-path.outputs.matrix) }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4.2.2
      - name: Print environment
        run: |
          echo "Environment: ${{ matrix.environment }}"
      - name: Run tests
        run: |
          # Áí∞Â¢É„Å´Âøú„Åò„Åü„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åô„Çã„Ç≥„Éû„É≥„Éâ„Çí„Åì„Åì„Å´Ë®òËø∞
          echo "Running tests for env: ${{ matrix.environment }}"
          # ‰æã: ./run_tests.sh ${{ matrix.environment }}

  # test-output:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     output1: ${{ steps.step1.outputs.test }}
  #     output2: ${{ steps.step2.outputs.test }}
  #   steps:
  #     - name: Check out repository code
  #       uses: actions/checkout@v4.2.2
  #     - id: step1
  #       run: echo "test=hello" >> "$GITHUB_OUTPUT"
  #     - id: step2
  #       run: echo "test=world" >> "$GITHUB_OUTPUT"
  # get-output:
  #   runs-on: ubuntu-latest
  #   needs: test-output
  #   steps:
  #     - env:
  #         OUTPUT1: ${{needs.test-output.outputs.output1}}
  #         OUTPUT2: ${{needs.test-output.outputs.output2}}
  #       run: echo "$OUTPUT1 $OUTPUT2"
  # job1:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     matrix: ${{ steps.set-matrix.outputs.matrix }}
  #   steps:
  #     - id: set-matrix
  #       run: echo "matrix={\"include\":[{\"project\":\"foo\",\"config\":\"Debug\"},{\"project\":\"bar\",\"config\":\"Release\"}]}" >> $GITHUB_OUTPUT
  # job2:
  #   needs: job1
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix: ${{ fromJSON(needs.job1.outputs.matrix) }}
  #   steps:
  #     - run: echo "Matrix - Project ${{ matrix.project }}, Config ${{ matrix.config }}"
  # detect-changed-environments:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     matrix: ${{ steps.set-matrix.outputs.matrix }}
  #   steps:
  #     - name: Check out repository code
  #       uses: actions/checkout@v4.2.2
  #     - name: Get list of changed files
  #       id: changed_files
  #       run: |
  #         git fetch origin ${{ github.event.before }} --depth=1
  #         git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
  #         cat changed_files.txt
  #     - name: Determine changed environments
  #       id: set-matrix
  #       run: |
  #         # Áπ∞„ÇäËøî„ÅóÂá¶ÁêÜ„ÅßÁí∞Â¢É„ÇíÂèñÂæó
  #         ENVIRONMENTS=()
  #         while read file; do
  #           case "$file" in
  #             'xxx/dev/version.json')
  #               ENVIRONMENTS+=("dev")
  #               ;;
  #             'xxx/stg/version.json')
  #               ENVIRONMENTS+=("stg")
  #               ;;
  #             'xxx/prd/version.json')
  #               ENVIRONMENTS+=("prd")
  #               ;;
  #           esac
  #         done < changed_files.txt
  #         # Áí∞Â¢É„ÅåÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫„ÅÆÈÖçÂàó„ÇíÂá∫Âäõ
  #         if [ ${#ENVIRONMENTS[@]} -eq 0 ]; then
  #           echo "No environments changed."
  #           echo '{"include":[]}' > matrix.json
  #         else
  #           # ENVIRONMENTSÈÖçÂàó„ÇíJSONÈÖçÂàó„Å´Â§âÊèõ
  #           envs_json=$(printf '%s\n' "${ENVIRONMENTS[@]}" | jq -R . | jq -s .)
  #           echo "{\"environment\": $envs_json}" > matrix.json
  #         fi
  #         cat matrix.json
  #         echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT
  #         cat $GITHUB_OUTPUT
  # job2:
  #   runs-on: ubuntu-latest
  #   needs: detect-changed-environments
  #   strategy:
  #     matrix:
  #       environment: ${{ fromJSON(needs.detect-changed-environments.outputs.matrix) }}
  #   steps:
  #     - name: Check out repository code
  #       uses: actions/checkout@v4.2.2
  #     - name: Print environment
  #       run: |
  #         echo "Environment: ${{ matrix.environment }}"
  #     - name: Run tests
  #       run: |
  #         # Áí∞Â¢É„Å´Âøú„Åò„Åü„ÉÜ„Çπ„Éà„ÇíÂÆüË°å„Åô„Çã„Ç≥„Éû„É≥„Éâ„Çí„Åì„Åì„Å´Ë®òËø∞
  #         echo "Running tests for environment: ${{ matrix.environment }}"
  #         # ‰æã: ./run_tests.sh ${{ matrix.environment }}
  # job1:
  #   runs-on: ubuntu-latest
  #   # Map a step output to a job output
  #   outputs:
  #     output1: ${{ steps.step1.outputs.test }}
  #     output2: ${{ steps.step2.outputs.test }}
  #   steps:
  #     - id: step1
  #       run: echo "test=hello" >> "$GITHUB_OUTPUT"
  #     - id: step2
  #       run: echo "test=world" >> "$GITHUB_OUTPUT"
  # job2:
  #   runs-on: ubuntu-latest
  #   needs: job1
  #   steps:
  #     - env:
  #         OUTPUT1: ${{needs.job1.outputs.output1}}
  #         OUTPUT2: ${{needs.job1.outputs.output2}}
  #       run: echo "$OUTPUT1 $OUTPUT2"
